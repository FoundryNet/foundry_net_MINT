<!DOCTYPE html>
<html>
<head>
  <title>FoundryNet Monitor</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    window.supabase = createClient(
      'https://lsijwmklicmqtuqxhgnu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaWp3bWtsaWNtcXR1cXhoZ251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTY3ODQsImV4cCI6MjA3MjQ5Mjc4NH0.0J560GHHrIaRYlwEYgYBIsWuiRgZFiITXKvc8rXvP0Y'
    );
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Courier New', monospace; background:#000; color:#0f0; padding:20px; }
    h1 { font-size:1.5rem; margin-bottom:20px; border-bottom:2px solid #0f0; padding-bottom:10px; }
    h2 { font-size:1.2rem; margin:20px 0 10px 0; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:15px; margin-bottom:20px; }
    .metric { border:1px solid #0f0; padding:15px; background:#001100; }
    .metric.critical { border-color:#f00; background:#110000; animation:pulse 2s ease-in-out infinite; }
    .metric.warning { border-color:#ff0; background:#111100; }
    .metric.live { border-color:#0ff; background:#001111; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
    .metric-value{font-size:2rem;font-weight:bold;margin:10px 0;}
    .metric-label{font-size:0.9rem; opacity:0.7;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{text-align:left;padding:8px;border:1px solid #0f0;font-size:0.9rem;}
    th{background:#001100;}
    .timestamp{font-size:0.8rem;opacity:0.6;}
    .recent-badge{color:#0ff;font-weight:bold;font-size:0.7rem;}
    .alert-critical{border:1px solid #f00;background:#110000;padding:10px;margin:5px 0;color:#f00;}
    .alert-warning{border:1px solid #ff0;background:#111100;padding:10px;margin:5px 0;color:#ff0;}
    .alert-info{border:1px solid #0f0;background:#001100;padding:10px;margin:5px 0;color:#0f0;}
    .alert-live{border:1px solid #0ff;background:#001111;padding:10px;margin:5px 0;color:#0ff;}
    #refresh{position:fixed;top:20px;right:20px;background:#0f0;color:#000;border:none;padding:10px 20px;cursor:pointer;font-family:inherit;font-weight:bold;}
    #refresh:hover{background:#0ff;}
    .footer{margin-top:30px;padding-top:20px;border-top:1px solid #0f0;text-align:center;opacity:0.6;font-size:0.8rem;}
    .loading{opacity:0.5;}
    .new-job { background:#001111 !important; animation: flash 2s ease-in-out; }
    @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.7} }
  </style>
</head>
<body>
  <button id="refresh" onclick="loadData()">REFRESH</button>
  <h1>FOUNDRYNET LIVE MONITOR</h1>

  <div class="grid">
    <div class="metric" id="treasuryMetric">
      <div class="metric-label">TREASURY BALANCE</div>
      <div class="metric-value" id="treasury">--</div>
      <div class="metric-label">MINT / SOL</div>
    </div>
    <div class="metric live">
      <div class="metric-label">LATEST JOBS</div>
      <div class="metric-value" id="latestCount">--</div>
      <div class="metric-label">last 50 completed</div>
    </div>
    <div class="metric live">
      <div class="metric-label">ACTIVE MACHINES</div>
      <div class="metric-value" id="machines">--</div>
      <div class="metric-label">in latest batch</div>
    </div>
    <div class="metric live">
      <div class="metric-label">MINT DISTRIBUTED</div>
      <div class="metric-value" id="mintDist">--</div>
      <div class="metric-label">latest jobs</div>
    </div>
  </div>

  <div class="grid">
    <div class="metric">
      <div class="metric-label">AVG REWARD</div>
      <div class="metric-value" id="avgReward">--</div>
      <div class="metric-label">MINT per job</div>
    </div>
    <div class="metric">
      <div class="metric-label">REWARD RANGE</div>
      <div class="metric-value" id="rewardRange">--</div>
      <div class="metric-label">min ‚Üí max</div>
    </div>
    <div class="metric">
      <div class="metric-label">TOTAL MACHINES</div>
      <div class="metric-value" id="totalMachines">--</div>
      <div class="metric-label">all time registered</div>
    </div>
    <div class="metric">
      <div class="metric-label">LAST JOB</div>
      <div class="metric-value" id="lastJobTime">--</div>
      <div class="metric-label">minutes ago</div>
    </div>
  </div>

  <div class="grid">
    <div class="metric">
      <div class="metric-label">ACTIVITY RATIO</div>
      <div class="metric-value" id="activityRatio">--</div>
      <div class="metric-label">dynamic supply</div>
    </div>
    <div class="metric">
      <div class="metric-label">REWARD MULTIPLIER</div>
      <div class="metric-value" id="rewardMultiplier">--</div>
      <div class="metric-label">current adjustment</div>
    </div>
    <div class="metric">
      <div class="metric-label">BURN RATE</div>
      <div class="metric-value" id="burnRate">--</div>
      <div class="metric-label">MINT per hour</div>
    </div>
    <div class="metric">
      <div class="metric-label">RUNWAY</div>
      <div class="metric-value" id="runway">--</div>
      <div class="metric-label">days remaining</div>
    </div>
  </div>

  <h2>NETWORK STATUS</h2>
  <div id="alerts">
    <div class="alert-info">Loading...</div>
  </div>

  <h2>LATEST JOBS (LIVE FEED - NO TIME FILTER)</h2>
  <table id="jobsTable">
    <thead>
      <tr>
        <th>JOB HASH</th>
        <th>MACHINE</th>
        <th>REWARD</th>
        <th>DURATION</th>
        <th>TX</th>
        <th>COMPLETED</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6" style="text-align:center;opacity:0.5">Loading...</td></tr>
    </tbody>
  </table>

  <div class="footer">
    <div id="lastUpdate">Last update: --</div>
    <div>FoundryNet: Digital Oil Protocol | Supply expands with activity, contracts with less usage | Rewards asymptotically adjust</div>
  </div>

  <script type="module">
    const METRICS_ENDPOINT = 'https://lsijwmklicmqtuqxhgnu.supabase.co/functions/v1/main-ts/metrics';
    const MIN_BALANCE = 10;
    let lastJobHash = null;

    async function getLatestJobs() {
      try {
        const { data: jobs, error } = await window.supabase
          .from('jobs')
          .select('*')
          .eq('status', 'completed')
          .order('completed_at', { ascending: false })
          .limit(50);
        
        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }
        
        console.log(`Fetched ${jobs?.length || 0} latest jobs`);
        return jobs || [];
      } catch (err) {
        console.error('Failed to fetch jobs:', err);
        return [];
      }
    }

    async function getMetrics() {
      try {
        const response = await fetch(METRICS_ENDPOINT, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (err) {
        console.error('Failed to fetch metrics:', err);
        return null;
      }
    }

    async function loadData() {
      document.getElementById('refresh').classList.add('loading');
      try {
        // Get metrics from backend
        const metrics = await getMetrics();
        
        // Treasury data
        const treasuryEl = document.getElementById('treasury');
        const treasuryMetric = document.getElementById('treasuryMetric');

        if (metrics && metrics.treasury) {
          const mint = metrics.treasury.balance_mint ?? null;
          const sol = metrics.treasury.balance_sol ?? null;
          
          if (mint !== null && sol !== null) {
            treasuryEl.textContent = `${mint.toFixed(2)} MINT / ${sol.toFixed(3)} SOL`;
            if (mint < MIN_BALANCE) {
              treasuryMetric.classList.add('critical');
            } else if (mint < MIN_BALANCE * 2) {
              treasuryMetric.classList.add('warning');
            } else {
              treasuryMetric.classList.remove('critical', 'warning');
            }
          } else {
            treasuryEl.textContent = 'FETCHING...';
          }

          // Dynamic supply metrics
          document.getElementById('activityRatio').textContent = metrics.activity?.activity_ratio?.toFixed(2) ?? '--';
          document.getElementById('rewardMultiplier').textContent = metrics.activity?.activity_multiplier?.toFixed(3) ?? '--';

          // Burn rate and runway
          const burnRate = metrics.treasury.burn_rate_per_hour ?? null;
          const runway = metrics.treasury.runway_days ?? null;
          
          document.getElementById('burnRate').textContent = burnRate !== null ? burnRate.toFixed(3) : '--';
          document.getElementById('runway').textContent = runway !== null ? runway.toFixed(1) : '--';
        } else {
          treasuryEl.textContent = 'ERROR';
          document.getElementById('activityRatio').textContent = '--';
          document.getElementById('rewardMultiplier').textContent = '--';
          document.getElementById('burnRate').textContent = '--';
          document.getElementById('runway').textContent = '--';
        }

        // Get latest jobs
        const latestJobs = await getLatestJobs();
        
        // Calculate metrics
        const jobsCount = latestJobs.length;
        const activeNodes = new Set(latestJobs.map(j => j.machine_uuid)).size;
        const totalMint = latestJobs.reduce((sum, j) => sum + Number(j.reward_amount_numeric || 0), 0);
        const avgReward = jobsCount > 0 ? totalMint / jobsCount : 0;
        
        const rewards = latestJobs.map(j => Number(j.reward_amount_numeric || 0)).filter(r => r > 0);
        const minReward = rewards.length > 0 ? Math.min(...rewards) : 0;
        const maxReward = rewards.length > 0 ? Math.max(...rewards) : 0;
        
        // Time since last job
        const lastJobTimestamp = latestJobs[0]?.completed_at;
        const minutesAgo = lastJobTimestamp 
          ? Math.floor((Date.now() - new Date(lastJobTimestamp).getTime()) / 60000)
          : 999;
        
        // Update metrics
        document.getElementById('latestCount').textContent = jobsCount;
        document.getElementById('machines').textContent = activeNodes;
        document.getElementById('mintDist').textContent = totalMint.toFixed(2);
        document.getElementById('avgReward').textContent = avgReward.toFixed(3);
        document.getElementById('rewardRange').textContent = `${minReward.toFixed(2)} ‚Üí ${maxReward.toFixed(2)}`;
        document.getElementById('lastJobTime').textContent = minutesAgo < 60 ? minutesAgo : '60+';

        // Get total machines count
        try {
          const { count: machineCount } = await window.supabase
            .from('machines')
            .select('*', { count: 'exact', head: true });
          document.getElementById('totalMachines').textContent = machineCount || 0;
        } catch (err) {
          console.error('Failed to get machine count:', err);
          document.getElementById('totalMachines').textContent = '?';
        }

        // Update jobs table
        const tbody = document.querySelector('#jobsTable tbody');
        tbody.innerHTML = '';
        
        if (latestJobs.length > 0) {
          latestJobs.slice(0, 20).forEach((job, idx) => {
            const row = tbody.insertRow();
            if (idx === 0 && lastJobHash && job.job_hash !== lastJobHash) {
              row.classList.add('new-job');
            }
            
            const completedAt = new Date(job.completed_at);
            const ageMin = Math.floor((Date.now() - completedAt.getTime()) / 60000);
            const timeStr = ageMin < 60 ? `${ageMin}m ago` : completedAt.toLocaleDateString();
            
            row.innerHTML = `
              <td>${job.job_hash.substring(0, 16)}...</td>
              <td>${job.machine_uuid.substring(0, 10)}...</td>
              <td style="color:#0ff;font-weight:bold">${(job.reward_amount_numeric || 0).toFixed(3)} MINT</td>
              <td>${job.duration_seconds || 0}s</td>
              <td>${job.tx_signature ? `<a href="https://solscan.io/tx/${job.tx_signature}" target="_blank" style="color:#0ff">VIEW</a>` : '--'}</td>
              <td class="timestamp">${timeStr}${ageMin < 5 ? ' <span class="recent-badge">üî¥ LIVE</span>' : ''}</td>
            `;
          });
          
          if (latestJobs[0]) {
            lastJobHash = latestJobs[0].job_hash;
          }
        } else {
          const row = tbody.insertRow();
          row.innerHTML = '<td colspan="6" style="text-align:center;opacity:0.5">No completed jobs found</td>';
        }

        // Alerts
        const alertsDiv = document.getElementById('alerts');
        alertsDiv.innerHTML = '';
        
        if (metrics && metrics.treasury) {
          const mint = metrics.treasury.balance_mint;
          if (mint !== null && mint < MIN_BALANCE) {
            alertsDiv.innerHTML += '<div class="alert-critical">‚ö†Ô∏è CRITICAL: Treasury below minimum!</div>';
          } else if (mint !== null && mint < MIN_BALANCE * 2) {
            alertsDiv.innerHTML += '<div class="alert-warning">‚ö†Ô∏è WARNING: Treasury low</div>';
          }
        }
        
        if (minutesAgo < 5) {
          alertsDiv.innerHTML += '<div class="alert-live">üî¥ LIVE: Job completed ' + minutesAgo + ' minutes ago</div>';
        } else if (minutesAgo < 15) {
          alertsDiv.innerHTML += '<div class="alert-info">‚úÖ ACTIVE: Recent job ' + minutesAgo + ' minutes ago</div>';
        } else if (minutesAgo < 60) {
          alertsDiv.innerHTML += '<div class="alert-info">‚ÑπÔ∏è Last job ' + minutesAgo + ' minutes ago</div>';
        } else {
          alertsDiv.innerHTML += '<div class="alert-warning">‚ö†Ô∏è No recent jobs (60+ minutes)</div>';
        }
        
        alertsDiv.innerHTML += `<div class="alert-info">üìä ${jobsCount} jobs tracked | ${activeNodes} active machines | ${totalMint.toFixed(2)} MINT distributed</div>`;
        
        if (alertsDiv.innerHTML === '') {
          alertsDiv.innerHTML = '<div class="alert-info">‚úÖ All systems normal</div>';
        }

        document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
      } catch (err) { 
        console.error('Dashboard error:', err);
        const alertsDiv = document.getElementById('alerts');
        alertsDiv.innerHTML = `<div class="alert-critical">‚ö†Ô∏è ERROR: ${err.message}</div>`;
      } finally { 
        document.getElementById('refresh').classList.remove('loading'); 
      }
    }

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
