<!DOCTYPE html>
<html>
<head>
  <title>FoundryNet Monitor</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Courier New', monospace; background:#000; color:#0f0; padding:20px; }
    h1 { font-size:1.5rem; margin-bottom:20px; border-bottom:2px solid #0f0; padding-bottom:10px; }
    h2 { font-size:1.2rem; margin:30px 0 15px 0; border-bottom:1px solid #0f0; padding-bottom:8px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
    .metric { border:1px solid #0f0; padding:15px; background:#001100; }
    .metric.ml { border-color:#f0f; background:#110011; }
    .metric-value { font-size:2rem; font-weight:bold; margin:10px 0; }
    .metric-label { font-size:0.9rem; opacity:0.7; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { text-align:left; padding:10px; border:1px solid #0f0; font-size:0.9rem; }
    th { background:#001100; }
    tr.flagged { background:#220011; }
    tr.warning { background:#111100; }
    .alert-ml { border:1px solid #f0f; background:#110011; padding:10px; margin:5px 0; color:#f0f; }
    .alert-info { border:1px solid #0f0; background:#001100; padding:10px; margin:5px 0; color:#0f0; }
    #refresh { position:fixed; top:20px; right:20px; background:#0f0; color:#000; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; }
    #refresh:hover { background:#0ff; }
    #exportBtn { position:fixed; top:20px; right:140px; background:#f0f; color:#000; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; }
    #exportBtn:hover { background:#0ff; }
    .footer { margin-top:40px; padding-top:20px; border-top:1px solid #0f0; text-align:center; opacity:0.6; font-size:0.8rem; }
    .confidence-bar { height:8px; background:#001100; border:1px solid #0f0; margin-top:4px; }
    .confidence-fill { height:100%; }
    .confidence-fill.clean { background:#0f0; }
    .confidence-fill.neutral { background:#ff0; }
    .confidence-fill.flagged { background:#f00; }
    .trust-delta { font-weight:bold; }
    .trust-delta.positive { color:#0f0; }
    .trust-delta.negative { color:#f00; }
    .dispute-btn { background:#333; color:#f0f; border:1px solid #f0f; padding:4px 8px; cursor:pointer; font-size:0.75rem; }
    .dispute-btn:hover { background:#f0f; color:#000; }
    .dispute-btn.disputed { background:#f0f; color:#000; cursor:default; }
  </style>
</head>
<body>
  <button id="refresh" onclick="loadData()">‚ü≥ REFRESH</button>
  <button id="exportBtn" onclick="exportData()">üì• EXPORT CSV</button>
  
  <h1>FOUNDRYNET MONITOR</h1>

  <h2 style="border-color:#f0f;color:#f0f;">üß† ML IMMUNE SYSTEM</h2>
  <div class="grid">
    <div class="metric ml">
      <div class="metric-label">STATUS</div>
      <div class="metric-value" id="mlStatus">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">JOBS SCORED</div>
      <div class="metric-value" id="mlJobsScored">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">MACHINES</div>
      <div class="metric-value" id="mlMachines">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">DISPUTES</div>
      <div class="metric-value" id="mlDisputes">--</div>
    </div>
  </div>

  <div class="grid">
    <div class="metric ml">
      <div class="metric-label">üî¥ FLAG STRONG</div>
      <div class="metric-value" id="mlFlagStrong">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">üü° FLAG SOFT</div>
      <div class="metric-value" id="mlFlagSoft">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">‚úÖ CLEAN</div>
      <div class="metric-value" id="mlClean">--</div>
    </div>
    <div class="metric ml">
      <div class="metric-label">AVG COMPLEXITY</div>
      <div class="metric-value" id="mlNetworkComplexity">--</div>
    </div>
  </div>

  <div id="alerts"></div>

  <h2 style="border-color:#f0f;color:#f0f;">RECENT ML SCORES</h2>
  <table id="mlScoresTable">
    <thead>
      <tr>
        <th>TIME</th>
        <th>MACHINE</th>
        <th>DUR</th>
        <th>CMPLX</th>
        <th>CONFIDENCE</th>
        <th>ACTION</th>
        <th>TRUST</th>
        <th>CHAIN</th>
        <th>DISPUTE</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="9" style="text-align:center;opacity:0.5">Loading...</td></tr>
    </tbody>
  </table>

  <div class="footer">
    <div id="lastUpdate">Last update: --</div>
    <div>FoundryNet | ML-Powered Economic Immune System | Devnet</div>
  </div>

  <script>
    const ML_ENDPOINT = 'https://web-production-4ab01.up.railway.app';
    let disputedJobs = new Set();

    async function loadData() {
      document.getElementById('refresh').style.opacity = '0.5';
      
      try {
        const [health, stats, scores] = await Promise.all([
          fetch(`${ML_ENDPOINT}/health`).then(r => r.json()).catch(() => null),
          fetch(`${ML_ENDPOINT}/stats`).then(r => r.json()).catch(() => null),
          fetch(`${ML_ENDPOINT}/recent-scores`).then(r => r.json()).catch(() => null)
        ]);

        // Health
        if (health) {
          document.getElementById('mlStatus').textContent = health.status === 'healthy' ? 'ACTIVE' : 'OFFLINE';
          document.getElementById('mlStatus').style.color = health.status === 'healthy' ? '#0f0' : '#f00';
          document.getElementById('mlJobsScored').textContent = health.jobs || 0;
          document.getElementById('mlMachines').textContent = health.machines || 0;
          document.getElementById('mlDisputes').textContent = health.disputes || 0;
        }

        // Stats
        if (stats) {
          document.getElementById('mlNetworkComplexity').textContent = stats.network_avg_complexity?.toFixed(2) || '--';
        }

        // Scores
        if (scores && scores.jobs) {
          const jobs = scores.jobs;
          let flagStrong = 0, flagSoft = 0, clean = 0;

          jobs.forEach(job => {
            if (job.action === 'flag_strong') flagStrong++;
            else if (job.action === 'flag_soft') flagSoft++;
            else if (job.action === 'clean') clean++;
          });

          document.getElementById('mlFlagStrong').textContent = flagStrong;
          document.getElementById('mlFlagSoft').textContent = flagSoft;
          document.getElementById('mlClean').textContent = clean;

          // Alerts
          const alertsDiv = document.getElementById('alerts');
          alertsDiv.innerHTML = `<div class="alert-ml">üß† ${jobs.length} scored | ${flagStrong} strong flags | ${flagSoft} soft | ${clean} clean</div>`;

          // Table
          const tbody = document.querySelector('#mlScoresTable tbody');
          tbody.innerHTML = '';

          jobs.slice().reverse().slice(0, 30).forEach(job => {
            const row = tbody.insertRow();
            const conf = (job.confidence * 100).toFixed(1);
            
            if (job.action === 'flag_strong') row.classList.add('flagged');
            else if (job.action === 'flag_soft') row.classList.add('warning');

            const confClass = job.confidence > 0.7 ? 'flagged' : job.confidence > 0.5 ? 'neutral' : 'clean';
            const trustClass = job.trust_delta > 0 ? 'positive' : job.trust_delta < 0 ? 'negative' : '';
            const trustSign = job.trust_delta > 0 ? '+' : '';
            
            const chainStatus = job.trust_update?.status === 'sent' ? '‚úì' : job.trust_update?.status === 'error' ? '‚úó' : '‚è≥';
            const chainColor = job.trust_update?.status === 'sent' ? '#0f0' : job.trust_update?.status === 'error' ? '#f00' : '#ff0';
            
            const jobHash = job.job_hash || '';
            const isDisputed = disputedJobs.has(jobHash);
            const disputeBtn = isDisputed 
              ? `<button class="dispute-btn disputed">DISPUTED</button>`
              : `<button class="dispute-btn" onclick="openDispute('${jobHash}', '${job.action}')">DISPUTE</button>`;

            row.innerHTML = `
              <td style="font-size:0.75rem">${job.timestamp?.substring(11, 19) || '--'}</td>
              <td style="font-size:0.75rem">${job.machine_id?.substring(0, 6) || '--'}...</td>
              <td>${job.duration_seconds || '--'}s</td>
              <td style="color:#0ff">${job.complexity_claimed?.toFixed(2) || '--'}</td>
              <td>
                <span style="color:${confClass === 'flagged' ? '#f00' : confClass === 'neutral' ? '#ff0' : '#0f0'}">${conf}%</span>
                <div class="confidence-bar"><div class="confidence-fill ${confClass}" style="width:${conf}%"></div></div>
              </td>
              <td style="color:${job.action === 'flag_strong' ? '#f00' : job.action === 'flag_soft' ? '#ff0' : '#0f0'}">${job.action || '--'}</td>
              <td><span class="trust-delta ${trustClass}">${trustSign}${job.trust_delta || 0}</span></td>
              <td style="color:${chainColor}">${chainStatus}</td>
              <td>${disputeBtn}</td>
            `;
          });
        }

        document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        console.error('Load error:', err);
      }
      
      document.getElementById('refresh').style.opacity = '1';
    }

    function openDispute(jobHash, currentAction) {
      const type = currentAction.includes('flag') 
        ? 'false_positive' 
        : 'false_negative';
      
      const reason = prompt(`Dispute this ${currentAction} decision?\n\nType: ${type}\nReason (optional):`);
      
      if (reason !== null) {
        submitDispute(jobHash, type, reason);
      }
    }

    async function submitDispute(jobHash, type, reason) {
      try {
        const response = await fetch(`${ML_ENDPOINT}/dispute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_hash: jobHash,
            dispute_type: type,
            reason: reason || ''
          })
        });
        
        if (response.ok) {
          disputedJobs.add(jobHash);
          alert('‚úÖ Dispute recorded for retraining');
          loadData();
        } else {
          alert('‚ùå Failed to submit dispute');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function exportData() {
      window.open(`${ML_ENDPOINT}/export-training-data`, '_blank');
    }

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
