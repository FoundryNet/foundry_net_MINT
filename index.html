<!DOCTYPE html>
<html>
<head>
  <title>FoundryNet Monitor</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    window.supabase = createClient(
      'https://lsijwmklicmqtuqxhgnu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaWp3bWtsaWNtcXR1cXhoZ251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTY3ODQsImV4cCI6MjA3MjQ5Mjc4NH0.0J560GHHrIaRYlwEYgYBIsWuiRgZFiITXKvc8rXvP0Y'
    );
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Courier New', monospace; background:#000; color:#0f0; padding:20px; }
    h1 { font-size:1.5rem; margin-bottom:20px; border-bottom:2px solid #0f0; padding-bottom:10px; }
    h2 { font-size:1.2rem; margin:20px 0 10px 0; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:15px; margin-bottom:20px; }
    .metric { border:1px solid #0f0; padding:15px; background:#001100; }
    .metric.critical { border-color:#f00; background:#110000; animation:pulse 2s ease-in-out infinite; }
    .metric.warning { border-color:#ff0; background:#111100; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
    .metric-value{font-size:2rem;font-weight:bold;margin:10px 0;}
    .metric-label{font-size:0.9rem; opacity:0.7;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{text-align:left;padding:8px;border:1px solid #0f0;}
    th{background:#001100;}
    .timestamp{font-size:0.8rem;opacity:0.6;}
    .alert-critical{border:1px solid #f00;background:#110000;padding:10px;margin:5px 0;color:#f00;}
    .alert-warning{border:1px solid #ff0;background:#111100;padding:10px;margin:5px 0;color:#ff0;}
    .alert-info{border:1px solid #0f0;background:#001100;padding:10px;margin:5px 0;color:#0f0;}
    #refresh{position:fixed;top:20px;right:20px;background:#0f0;color:#000;border:none;padding:10px 20px;cursor:pointer;font-family:inherit;font-weight:bold;}
    #refresh:hover{background:#0ff;}
    .footer{margin-top:30px;padding-top:20px;border-top:1px solid #0f0;text-align:center;opacity:0.6;font-size:0.8rem;}
    .loading{opacity:0.5;}
  </style>
</head>
<body>
  <button id="refresh" onclick="loadData()">REFRESH</button>
  <h1>FOUNDRYNET LIVE MONITOR</h1>

  <div class="grid">
    <div class="metric" id="treasuryMetric">
      <div class="metric-label">TREASURY BALANCE</div>
      <div class="metric-value" id="treasury">--</div>
      <div class="metric-label">MINT / SOL</div>
    </div>
    <div class="metric">
      <div class="metric-label">JOBS TODAY</div>
      <div class="metric-value" id="jobsToday">--</div>
      <div class="metric-label" id="completionRate">-- completion</div>
    </div>
    <div class="metric">
      <div class="metric-label">ACTIVE MACHINES</div>
      <div class="metric-value" id="machines">--</div>
      <div class="metric-label">registered</div>
    </div>
    <div class="metric">
      <div class="metric-label">MINT DISTRIBUTED</div>
      <div class="metric-value" id="mintDist">--</div>
      <div class="metric-label">all time</div>
    </div>
  </div>

  <div class="grid">
    <div class="metric">
      <div class="metric-label">ACTIVITY RATIO</div>
      <div class="metric-value" id="activityRatio">--</div>
      <div class="metric-label">0.5-2.0 range</div>
    </div>
    <div class="metric">
      <div class="metric-label">ACTIVITY MULTIPLIER</div>
      <div class="metric-value" id="activityMult">--</div>
      <div class="metric-label">reward adjustment</div>
    </div>
    <div class="metric">
      <div class="metric-label">BURN RATE</div>
      <div class="metric-value" id="burnRate">--</div>
      <div class="metric-label">MINT/hour</div>
    </div>
    <div class="metric">
      <div class="metric-label">RUNWAY</div>
      <div class="metric-value" id="runway">--</div>
      <div class="metric-label">days until depleted</div>
    </div>
  </div>

  <h2>ACTIVE ALERTS</h2>
  <div id="alerts">
    <div class="alert-info">No active alerts</div>
  </div>

  <h2>RECENT JOBS</h2>
  <table id="jobsTable">
    <thead>
      <tr>
        <th>JOB HASH</th>
        <th>MACHINE</th>
        <th>STATUS</th>
        <th>REWARD</th>
        <th>ACTIVITY</th>
        <th>TX</th>
        <th>TIME</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>RECENT MINTING EVENTS</h2>
  <table id="mintingTable">
    <thead>
      <tr>
        <th>AMOUNT MINTED</th>
        <th>REASON</th>
        <th>ACTIVITY RATIO</th>
        <th>TIMESTAMP</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="footer">
    <div id="lastUpdate">Last update: --</div>
    <div>FoundryNet Protocol Monitor v1.0 | Activity-Responsive Settlement Layer</div>
  </div>

  <script type="module">
    const SOLANA_RPC = 'https://mainnet.helius-rpc.com/?api-key=2c13462d-4a64-4c5b-b410-1520219d73aa';
    const HOT_WALLET = 'GHUXNW7j3MY5ALVK6ZArt6kzDRYKZ9NYSKwFKCM8twL7';
    const MINT_ADDRESS = '5Pd4YBgFdih88vAFGAEEsk2JpixrZDJpRynTWvqPy5da';
    const MIN_BALANCE = 10;

    async function getTreasuryBalances() {
      try {
        const connection = new solanaWeb3.Connection(SOLANA_RPC, 'confirmed');
        const publicKey = new solanaWeb3.PublicKey(HOT_WALLET);
        const solLamports = await connection.getBalance(publicKey);
        const solBalance = solLamports / solanaWeb3.LAMPORTS_PER_SOL;
        const mintPublicKey = new solanaWeb3.PublicKey(MINT_ADDRESS);
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(publicKey, { mint: mintPublicKey });
        const mintBalance = tokenAccounts.value.length > 0 ? tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount : 0;
        return { sol: solBalance, mint: mintBalance };
      } catch(err) {
        console.error('Failed to fetch balances:', err);
        return { sol: null, mint: null };
      }
    }

    async function loadData() {
      document.getElementById('refresh').classList.add('loading');
      try {
        const balances = await getTreasuryBalances();
        const treasuryEl = document.getElementById('treasury');
        const treasuryMetric = document.getElementById('treasuryMetric');

        if(balances.mint!==null && balances.sol!==null){
          treasuryEl.textContent = `${balances.mint.toFixed(2)} MINT / ${balances.sol.toFixed(3)} SOL`;
          if(balances.mint < MIN_BALANCE) treasuryMetric.classList.add('critical');
          else if(balances.mint < MIN_BALANCE*2) treasuryMetric.classList.add('warning');
          else treasuryMetric.classList.remove('critical','warning');
        } else treasuryEl.textContent='ERROR';

        const { data: jobs, error: jobsError } = await window.supabase
          .from('jobs')
          .select('*')
          .order('created_at',{ascending:false})
          .limit(50);
        if(jobsError){ console.error('Supabase error:', jobsError); return; }

        const { count: machineCount } = await window.supabase
          .from('machines')
          .select('*',{count:'exact',head:true});

        const { data: payouts } = await window.supabase
          .from('payouts')
          .select('amount, activity_ratio');

        const { data: mintingEvents } = await window.supabase
          .from('minting_events')
          .select('*')
          .order('timestamp', {ascending:false})
          .limit(10);

        const totalMint = payouts?.reduce((sum,p)=>sum+Number(p.amount),0)||0;
        const avgActivityRatio = payouts && payouts.length > 0 
          ? payouts.reduce((sum,p)=>sum+Number(p.activity_ratio||1),0) / payouts.length
          : 1.0;

        const activityMult = Math.pow(Math.max(0.5, Math.min(2.0, avgActivityRatio)), -0.4);
        const burnRate = payouts?.length > 0 ? totalMint / 24 : 0;
        const runway = burnRate > 0 && balances.mint !== null ? balances.mint / (burnRate * 24) : 999;

        const today = new Date().toISOString().split('T')[0];
        const todayJobs = jobs.filter(j=>j.started_at?.startsWith(today))||[];
        const completedToday = todayJobs.filter(j=>j.status==='completed').length;

        document.getElementById('jobsToday').textContent = todayJobs.length;
        document.getElementById('completionRate').textContent = `${todayJobs.length>0?Math.round((completedToday/todayJobs.length)*100):0}% completion`;
        document.getElementById('machines').textContent = machineCount||0;
        document.getElementById('mintDist').textContent = totalMint.toFixed(2);
        document.getElementById('activityRatio').textContent = avgActivityRatio.toFixed(2);
        document.getElementById('activityMult').textContent = activityMult.toFixed(3);
        document.getElementById('burnRate').textContent = burnRate.toFixed(2);
        document.getElementById('runway').textContent = runway.toFixed(1);

        const tbody = document.querySelector('#jobsTable tbody');
        tbody.innerHTML='';
        todayJobs.slice(0,20).forEach(job=>{
          const row=tbody.insertRow();
          const statusColor = job.status==='completed'?'#0f0':job.status==='failed'?'#f00':'#ff0';
          row.innerHTML=`
            <td>${job.job_hash.substring(0,12)}...</td>
            <td>${job.machine_uuid.substring(0,8)}...</td>
            <td style="color:${statusColor}">${job.status.toUpperCase()}</td>
            <td>${(job.reward_amount_numeric||0).toFixed(2)} MINT</td>
            <td>${(job.activity_ratio||1).toFixed(2)}x</td>
            <td>${job.tx_signature?`<a href="https://solscan.io/tx/${job.tx_signature}" target="_blank" style="color:#0ff">VIEW</a>`:'--'}</td>
            <td class="timestamp">${job.started_at ? new Date(job.started_at).toLocaleString() : '--'}</td>
          `;
        });

        const mintTbody = document.querySelector('#mintingTable tbody');
        mintTbody.innerHTML='';
        (mintingEvents||[]).slice(0,10).forEach(evt=>{
          const row=mintTbody.insertRow();
          row.innerHTML=`
            <td>${(evt.amount||0).toFixed(2)} MINT</td>
            <td>${evt.reason||'--'}</td>
            <td>${(evt.activity_ratio||1).toFixed(2)}x</td>
            <td class="timestamp">${evt.timestamp ? new Date(evt.timestamp).toLocaleString() : '--'}</td>
          `;
        });

        const alertsDiv=document.getElementById('alerts');
        alertsDiv.innerHTML='';
        if(balances.mint!==null && balances.mint<MIN_BALANCE) alertsDiv.innerHTML+='<div class="alert-critical">⚠️ Treasury below minimum!</div>';
        else if(balances.mint!==null && balances.mint<MIN_BALANCE*2) alertsDiv.innerHTML+='<div class="alert-warning">⚠️ Treasury low</div>';
        if(todayJobs.length===0) alertsDiv.innerHTML+='<div class="alert-info">ℹ️ No jobs processed today</div>';
        if(avgActivityRatio > 1.5) alertsDiv.innerHTML+='<div class="alert-warning">⚠️ High activity - rewards cooling</div>';
        if(avgActivityRatio < 0.7) alertsDiv.innerHTML+='<div class="alert-info">ℹ️ Low activity - rewards heating</div>';

        document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
      } catch(err){ console.error('Dashboard error:', err); }
      finally{ document.getElementById('refresh').classList.remove('loading'); }
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
